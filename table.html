<!DOCTYPE html>
<html lang="zh-tw">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台鐵運行圖編輯</title>
    <style>
        table {
            width: 80%;
        }

        td {
            border: 1px solid #333;

        }

        thead,
        tfoot {
            background-color: #333;
            color: #fff;
        }
    </style>
</head>

<body>
    <div>
        <table>
            <thead>
                <tr>
                    <th>車次</th>
                    <th>順逆行</th>
                    <th>經由路線</th>
                    <th>列車種類</th>
                </tr>
            </thead>
            <tbody id="main-table">
                <!-- <tr>
                    <td>The table body</td>
                    <td>with two columns</td>
                    <td>The table body</td>
                    <td>with two columns</td>
                </tr> -->
            </tbody>
        </table>
    </div>
    <div id="pagination"></div>
    <div>
        <table>
            <thead>
                <tr>
                    <th>順序</th>
                    <th>車站</th>
                    <th>到站時間</th>
                    <th>離站時間</th>
                </tr>
            </thead>
            <tbody id="detail-table">
            </tbody>
        </table>
    </div>

</body>
<script>
    // 副表数据
    // var detailTable = [
    //     { id: 1, details: 'Details for John' },
    //     { id: 2, details: 'Details for Alice' },
    //     { id: 3, details: 'Details for Bob' }
    // ];

    // 主表数据
    // var mainTable = [
    //     { id: 1, name: 'John' },
    //     { id: 2, name: 'Alice' },
    //     { id: 3, name: 'Bob' }
    // ];

    let jsonData = null;
    let trains = null;
    let trains_timetable = [];

    function fetchData(url) {
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                jsonData = JSON.parse(this.responseText);
                // console.log(jsonData)
                processJSON(jsonData);
            }
        };
        xmlhttp.open("GET", url, true);
        xmlhttp.send();
    }

    fetchData('20230623.json');


    let mainTableContainer = null;
    let detailTableContainer = null;

    function processJSON(jsonData) {

        trains = jsonData.TrainInfos;

        for (const iterator of trains) {
            
            // iterator.TimeInfos.forEach(element => {
            //     element.train_no = iterator.Train;
            //     trains_timetable.push(element);
            // });
            // console.log(iterator.TimeInfos)
            trains_timetable.push({"Train": iterator.Train, "TimeTable": iterator.TimeInfos});
            // trains_timetable["TimeTable"] = iterator.TimeInfos;
        }

        mainTableContainer = document.getElementById('main-table');
        detailTableContainer = document.getElementById('detail-table');

        displayData();
    }

    let itemsPerPage = 20; // 每页显示的行数
    let currentPage = 1; // 当前页码

    function displayData() {
        // 清空表格内容
        mainTableContainer.innerHTML = '';

        let startIndex = (currentPage - 1) * itemsPerPage;
        let endIndex = startIndex + itemsPerPage;

        // 显示当前页的数据
        var currentPageData = trains.slice(startIndex, endIndex);
        currentPageData.forEach(function (item) {
            let row = document.createElement('tr');
            // row.innerHTML = item.Train;
            row.addEventListener('click', function () {
                showDetails(item.Train);
            });
            mainTableContainer.appendChild(row);
            add_td(row, item.Train);
            add_td(row, item.LineDir);
            add_td(row, item.Line);
            add_td(row, item.CarClass);
        });

        // 更新分页导航
        updatePagination();
    }

    function add_td(row_element, inner_text) {
        let td = document.createElement('td');
        td.innerHTML = inner_text;
        row_element.appendChild(td);
    }

    function updatePagination() {
        pagination.innerHTML = '';

        var totalPages = Math.ceil(trains.length / itemsPerPage);

        var prevLink = document.createElement('a');
        prevLink.href = '#';
        prevLink.textContent = '上一頁';
        prevLink.addEventListener('click', function (e) {
            e.preventDefault();
            if (currentPage > 1) {
                currentPage--;
                displayData();
            }
        });
        pagination.appendChild(prevLink);

        var startPage = 1;
        var endPage = totalPages;

        if (totalPages > 5) {
            if (currentPage <= 3) {
                endPage = 5;
            } else if (currentPage >= totalPages - 2) {
                startPage = totalPages - 4;
            } else {
                startPage = currentPage - 2;
                endPage = currentPage + 2;
            }
        }

        if (startPage > 1) {
            var firstPageLink = document.createElement('a');
            firstPageLink.href = '#';
            firstPageLink.textContent = '1';
            firstPageLink.dataset.page = 1;
            firstPageLink.addEventListener('click', function (e) {
                e.preventDefault();
                currentPage = parseInt(this.dataset.page);
                displayData();
            });
            pagination.appendChild(firstPageLink);

            if (startPage > 2) {
                var ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                pagination.appendChild(ellipsis);
            }
        }

        for (var i = startPage; i <= endPage; i++) {
            var pageLink = document.createElement('a');
            pageLink.href = '#';
            pageLink.textContent = i;
            pageLink.dataset.page = i;

            if (i === currentPage) {
                pageLink.classList.add('active');
            }

            pageLink.addEventListener('click', function (e) {
                e.preventDefault();
                currentPage = parseInt(this.dataset.page);
                displayData();
            });

            pagination.appendChild(pageLink);

            if (i < endPage) {
                var spacing = document.createElement('span');
                spacing.textContent = ' ';
                pagination.appendChild(spacing);
            }
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                var ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                pagination.appendChild(ellipsis);
            }

            var lastPageLink = document.createElement('a');
            lastPageLink.href = '#';
            lastPageLink.textContent = totalPages;
            lastPageLink.dataset.page = totalPages;
            lastPageLink.addEventListener('click', function (e) {
                e.preventDefault();
                currentPage = parseInt(this.dataset.page);
                displayData();
            });
            pagination.appendChild(lastPageLink);
        }

        var nextLink = document.createElement('a');
        nextLink.href = '#';
        nextLink.textContent = '下一頁';
        nextLink.addEventListener('click', function (e) {
            e.preventDefault();
            if (currentPage < totalPages) {
                currentPage++;
                displayData();
            }
        });
        pagination.appendChild(nextLink);
    }


    // 根据主表项的ID显示副表数据
    function showDetails(id) {
        // 清空副表容器
        detailTableContainer.innerHTML = '';

        // 查找与主表ID匹配的副表项
        let details = trains_timetable.find(function (item) {
            return item.Train === id;
        });

        details.TimeTable.forEach(function (item) {
            let row = document.createElement('tr');
            detailTableContainer.appendChild(row);
            add_td(row, item.Order);
            add_td(row, item.Station);
            add_td(row, item.ARRTime);
            add_td(row, item.DEPTime);
  
            // detailTableContainer.appendChild(detailRow);
        });
    }

</script>

</html>